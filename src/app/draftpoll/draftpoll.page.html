<ion-header>
  <ion-toolbar style="padding-right:11px;">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Edit poll data</ion-title>
    <ion-thumbnail slot="end">
      <ion-img src="/assets/topright_icon.png"></ion-img>
    </ion-thumbnail>
  </ion-toolbar>
</ion-header>

<ion-content>
  <form [formGroup]="formGroup">

    <!--TODO: highlight (e.g. bigger, bold, colored etc.) current stage-->

    <ion-item color="primary">
      General information 
    </ion-item>
    <ion-item><!--stage 0-->
      <ion-label position="floating" color="primary"><span [class]="stage==0?'current-field':''">In this poll, the group will...</span></ion-label>
      <ion-select tabindex="0" formControlName="poll_type" cancelText="Cancel" okText="OK" 
          (ionChange)="stage=max(stage,formGroup.get('poll_type').valid?1:0)">
        <ion-select-option value="choice">...select one of several options</ion-select-option>
        <ion-select-option value="allocation">...divide some resource between several targets</ion-select-option>
      </ion-select>
    </ion-item>
    <div class="validation-errors">
      <ng-container *ngFor="let validation of validation_messages.poll_type">
        <div class="error-message" *ngIf="formGroup.get('poll_type').hasError(validation.type) 
            && (formGroup.get('poll_type').dirty || formGroup.get('poll_type').touched)">
          {{ validation.message }}
        </div>
      </ng-container>
    </div>
    <ng-container *ngIf="stage>0">
      <ion-item><!--stage 1-->
        <ion-label position="floating" color="primary"><span [class]="stage==1?'current-field':''">Poll title</span></ion-label>
        <ion-input tabindex="1" type="text" formControlName="poll_title" required placeholder="Some short headline, maybe in the form of a question, like 'what film to watch?'"
          (ionBlur)="stage=max(stage,formGroup.get('poll_title').valid?2:0)"></ion-input>      
      </ion-item>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.poll_title">
          <div class="error-message" *ngIf="formGroup.get('poll_title').hasError(validation.type) 
              && (formGroup.get('poll_title').dirty || formGroup.get('poll_title').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
    </ng-container>    
    <ng-container *ngIf="stage>1">
      <ion-item><!--stage 2-->
        <ion-label position="floating" color="primary"><span [class]="stage==2?'current-field':''">Description (optional)</span></ion-label>
        <ion-textarea tabindex="2" rows="3" type="text" formControlName="poll_descr" placeholder="Some more information about this poll?"
          (ionBlur)="stage=max(stage,formGroup.get('poll_descr').valid?3:0)"></ion-textarea>
        <ion-button *ngIf="stage==2 && formGroup.get('poll_descr').value==''" color="primary" slot="end">Skip</ion-button>
      </ion-item>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.poll_descr">
          <div class="error-message" *ngIf="formGroup.get('poll_descr').hasError(validation.type) 
              && (formGroup.get('poll_descr').dirty || formGroup.get('poll_descr').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
    </ng-container>    
    <ng-container *ngIf="stage>2">
      <ion-item><!--stage 3-->
        <ion-label position="floating" color="primary"><span [class]="stage==3?'current-field':''">“Read more” link (optional)</span></ion-label>
        <ion-input tabindex="3" type="text" formControlName="poll_url" placeholder="A link to some webpage containing more details?"
          (ionBlur)="stage=max(stage,formGroup.get('poll_url').valid?4:0)"></ion-input>
          <ion-button *ngIf="stage==3 && formGroup.get('poll_url').value==''" color="primary" slot="end">Skip</ion-button>
        </ion-item>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.poll_url">
          <div class="error-message" *ngIf="formGroup.get('poll_url').hasError(validation.type) 
              && (formGroup.get('poll_url').dirty || formGroup.get('poll_url').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
    </ng-container>    
    <ng-container *ngIf="stage>3">
      <ion-item><!--stage 4-->
        <ion-label position="floating" color="primary"><span [class]="stage==4?'current-field':''">Closing date and time</span></ion-label>
        <!--TODO: maybe use https://github.com/VitaliiBlagodir/cordova-plugin-datepicker instead-->
        <ion-datetime tabindex="4" formControlName="poll_closing_datetime" required pickerFormat="DD MMMM YYYY HH mm"
          displayFormat="DDDD, DD MMMM YYYY, HH:mm"
          (ionChange)="stage=max(stage,formGroup.get('poll_closing_datetime').valid?5:0)"></ion-datetime>
      </ion-item>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.poll_closing_datetime">
          <div class="error-message" *ngIf="formGroup.get('poll_closing_datetime').hasError(validation.type) 
              && (formGroup.get('poll_closing_datetime').dirty || formGroup.get('poll_closing_datetime').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
    </ng-container>    

    <ng-container *ngIf="stage>4"><!--stage 5-->
      <ion-item color="primary">
        {{formGroup.get('poll_type').value=='choice' ? 'Options' : 'Possible targets'}}
      </ion-item>

      <div *ngFor="let item of [].constructor(n_options); let i = index">
        <ion-item color="light"><!--option_stage 0-->
          <ion-button (click)="expanded[i]=!expanded[i]" fill="clear" slot="start" class="ion-no-padding ion-no-margin">
            <ion-icon [name]="expanded[i]?'caret-down-outline':'caret-forward-outline'" slot="icon-only" padding-top></ion-icon>
          </ion-button>
          <ion-label position="floating" color="primary"><span [class]="option_stage==0?'current-field':''">{{i < n_options-1 ? '' : i==0 ? 'First' : i==1 ? 'Second' : 'Another'}} {{formGroup.get('poll_type').value=='choice' ? 'Option' : 'Target'}} name{{i == n_options-1 && i > 1 ? '?' : ''}}</span></ion-label>
          <ion-input type="text" [formControlName]="'option_name'+i" required 
          [placeholder]="'A short name for this '+(formGroup.get('poll_type').value=='choice' ? 'option' : 'possible target')"
          (ionBlur)="option_stage=max(option_stage,formGroup.get('option_name'+i).valid?1:0);expanded[i]=true"></ion-input>      
          <ion-button *ngIf="i == n_options-1 && i > 1" color="primary" slot="end">No more for now</ion-button>
          </ion-item>
        <div class="validation-errors">
          <ng-container *ngFor="let validation of validation_messages.poll_title">
            <div class="error-message" *ngIf="formGroup.get('option_name'+i).hasError(validation.type) 
                && (formGroup.get('option_name'+i).dirty || formGroup.get('option_name'+i).touched)">
              {{ validation.message }}
            </div>
          </ng-container>
        </div>
        <ng-container *ngIf="option_stage>0 && expanded[i]">
          <ion-item><!--option_stage 1-->
            <ion-label position="floating" color="primary"><span [class]="option_stage==1?'current-field':''">Description (optional)</span></ion-label>
            <ion-textarea rows="3" type="text" [formControlName]="'option_descr'+i" 
              [placeholder]="'Some more information about ‘'+formGroup.get('option_name'+i).value+'’?'"
              (ionBlur)="option_stage=max(option_stage,formGroup.get('option_descr'+i).valid?2:0)"></ion-textarea>
            <ion-button *ngIf="option_stage==1 && i == n_options-1 && formGroup.get('option_descr'+i).value==''" color="primary" slot="end">Skip</ion-button>
          </ion-item>
          <div class="validation-errors">
            <ng-container *ngFor="let validation of validation_messages.poll_descr">
              <div class="error-message" *ngIf="formGroup.get('option_descr'+i).hasError(validation.type) 
                  && (formGroup.get('option_descr'+i).dirty || formGroup.get('option_descr'+i).touched)">
                {{ validation.message }}
              </div>
            </ng-container>
          </div>
        </ng-container>    
        <ng-container *ngIf="option_stage>1 && expanded[i]">
          <ion-item><!--option_stage 2-->
            <ion-label position="floating" color="primary"><span [class]="option_stage==2?'current-field':''">“Read more” link (optional)</span></ion-label>
            <ion-input type="text" [formControlName]="'option_url'+i" 
              [placeholder]="'A link to some webpage containing more details about ‘'+formGroup.get('option_name'+i).value+'’?'"
              (ionBlur)="blur_option_url(i)"></ion-input>
            <ion-button *ngIf="option_stage==2 && i == n_options-1 && formGroup.get('option_url'+i).value==''" color="primary" slot="end">Skip</ion-button>
          </ion-item>
          <div class="validation-errors">
            <ng-container *ngFor="let validation of validation_messages.poll_url">
              <div class="error-message" *ngIf="formGroup.get('option_url'+i).hasError(validation.type) 
                  && (formGroup.get('option_url'+i).dirty || formGroup.get('option_url'+i).touched)">
                {{ validation.message }}
              </div>
            </ng-container>
          </div>
        </ng-container>    
      </div>

      <ion-item>
        <small>Please list at least two {{formGroup.get('poll_type').value=='choice' ? 'options' : 'targets'}}. 
          Further {{formGroup.get('poll_type').value=='choice' ? 'options' : 'targets'}} 
          can always be added later by the group as long as the poll is running.</small>
      </ion-item>
    </ng-container>

    <ion-item><!--TODO: icons-->
      <ion-button color="light"><ion-icon name="trash-outline"></ion-icon>&nbsp;Cancel / delete</ion-button>&nbsp;
      <ion-button color="dark"><ion-icon name="save"></ion-icon>&nbsp;Save draft</ion-button>
      <ion-button color="primary" slot="end" [disabled]="!formGroup.valid"><ion-icon name="send"></ion-icon>&nbsp;Publish</ion-button>
    </ion-item>
  </form>
</ion-content>
