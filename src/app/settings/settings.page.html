<ion-header>
  <ion-toolbar style="padding-right:11px;">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Settings</ion-title>
    <ion-thumbnail slot="end">
      <ion-img src="/assets/topright_icon.png"></ion-img>
    </ion-thumbnail>
  </ion-toolbar>
</ion-header>

<ion-content>
  <form [formGroup]="formGroup">
    <ion-item color="primary">
      Data storage 
    </ion-item>
    <ion-item>
      <small>To be able to access your data safely from different devices, please give an email address, set a password, 
      and select a server where vodle will store your encrypted data. </small>
    </ion-item>
    <ion-grid class="ion-no-padding">
      <ion-row class="ion-no-padding ion-align-items-bottom">
        <ion-col class="ion-no-padding">
          <ion-item>
            <ion-label position="floating" color="primary">Email</ion-label>
            <ion-input type="text" formControlName="email" required [disabled]="!editing_email"></ion-input>      
            <!--TODO: click OK when hitting enter and valid-->
          </ion-item>
        </ion-col>
        <ion-button color="light" (click)="editing_email=!editing_email" [disabled]="editing_email && !formGroup.get('email').valid">
          <!--TODO: give focus to field-->
          <ion-icon [name]="editing_email?'checkmark-outline':'pencil-outline'"></ion-icon>{{editing_email?'OK':'edit'}}
        </ion-button>      
      </ion-row>
    </ion-grid>
    <div class="validation-errors">
    <ng-container *ngFor="let validation of validation_messages.email">
      <div class="error-message" *ngIf="formGroup.get('email').hasError(validation.type) 
          && (formGroup.get('email').dirty || formGroup.get('email').touched)">
        {{ validation.message }}
      </div>
    </ng-container>
    </div>

    <div formGroupName="pw">
      <ion-grid class="ion-no-padding">
        <ion-row class="ion-no-padding ion-align-items-bottom">
          <ion-col class="ion-no-padding">
            <ion-item>
              <ion-label position="floating" color="primary">Password</ion-label>
              <ion-input [type]="showing_password?'text':'password'" formControlName="password" required [disabled]="!editing_password"></ion-input><!--TODO: add show/hide toggle-->
            </ion-item>
          </ion-col>
          <ion-button color="light" (click)="showing_password=!showing_password">
            <ion-icon [name]="showing_password?'eye-off-outline':'eye-outline'"></ion-icon>&nbsp;{{showing_password?'hide':'show'}}
          </ion-button>      
          <ion-button color="light" (click)="editing_password=!editing_password" [disabled]="editing_password && !formGroup.get('pw').valid">
            <ion-icon [name]="editing_password?'checkmark-outline':'pencil-outline'"></ion-icon>{{editing_password?'OK':'edit'}}
          </ion-button>      
        </ion-row>
      </ion-grid>
      <div class="validation-errors">
      <ng-container *ngFor="let validation of validation_messages.password">
        <div class="error-message" *ngIf="formGroup.get('pw.password').hasError(validation.type) 
            && (formGroup.get('pw.password').dirty || formGroup.get('pw.password').touched)">
          {{ validation.message }}
        </div>
      </ng-container>
      </div>
      <ng-container *ngIf="editing_password">
        <ion-item>
          <ion-label position="floating" color="primary">Retype password</ion-label>
          <ion-input [type]="showing_password?'text':'password'" formControlName="confirm_password" required [disabled]="!editing_password"></ion-input>
        </ion-item>
        <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.passwords_match">
          <div class="error-message" *ngIf="formGroup.get('pw').hasError('must_match') 
              && (formGroup.get('pw.confirm_password').dirty || formGroup.get('pw.confirm_password').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
        </div>
      </ng-container>
    </div>

    <ion-item>
      <ion-label position="floating" color="primary">Server</ion-label>
      <ion-select formControlName="server" cancelText="Cancel" okText="OK">
        <ion-select-option value="default">vodle central default server</ion-select-option>
        <ion-select-option value="poll">same as for one of my polls</ion-select-option>
        <ion-select-option value="other">other</ion-select-option>
      </ion-select>
    </ion-item>
    <ng-container *ngIf="formGroup.get('server').value=='poll'">
      <ion-item>
        <ion-label position="floating" color="primary">Which poll's server do you want to use for your personal data?</ion-label>
        <ion-select formControlName="server_from_poll" cancelText="Cancel" okText="OK">
          <ion-select-option value="TODO">[TODO: list of all polls]</ion-select-option>
        </ion-select>
      </ion-item>
    </ng-container>    
    <ng-container *ngIf="formGroup.get('server').value=='other'">
      <ion-item>
        <small>Please enter the URL, username and password for any CouchDB database where you want your data to be stored:</small>
      </ion-item>
      <ion-item>
        <ion-label position="floating" color="primary">Database URL</ion-label>
        <ion-input type="text" formControlName="db_url" required></ion-input>
      </ion-item>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.db_url">
          <div class="error-message" *ngIf="formGroup.get('db_url').hasError(validation.type) 
              && (formGroup.get('db_url').dirty || formGroup.get('db_url').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
      <ion-item>
        <ion-label position="floating" color="primary">Database username</ion-label>
        <ion-input type="text" formControlName="db_username" required></ion-input>
      </ion-item>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.db_username">
          <div class="error-message" *ngIf="formGroup.get('db_username').hasError(validation.type) 
              && (formGroup.get('db_username').dirty || formGroup.get('db_username').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
      <ion-grid class="ion-no-padding">
        <ion-row class="ion-no-padding ion-align-items-bottom">
          <ion-col class="ion-no-padding">
            <ion-item>
              <ion-label position="floating" color="primary">Database password</ion-label>
              <ion-input [type]="showing_db_password?'text':'password'"  formControlName="db_password" required></ion-input>
            </ion-item>
          </ion-col>
          <ion-button color="light" (click)="showing_db_password=!showing_db_password">
            <ion-icon [name]="showing_db_password?'eye-off-outline':'eye-outline'"></ion-icon>&nbsp;{{showing_db_password?'hide':'show'}}
          </ion-button>      
        </ion-row>
      </ion-grid>
      <div class="validation-errors">
        <ng-container *ngFor="let validation of validation_messages.db_password">
          <div class="error-message" *ngIf="formGroup.get('db_password').hasError(validation.type) 
              && (formGroup.get('db_password').dirty || formGroup.get('db_password').touched)">
            {{ validation.message }}
          </div>
        </ng-container>
      </div>
    </ng-container>

    <!--<ion-item color="primary">
      Appearance 
    </ion-item>
    <ion-item>
      <ion-label position="floating" color="primary">Language</ion-label>
      <ion-select formControlName="language" cancelText="Cancel" okText="OK">
        <ion-select-option value="en">English</ion-select-option>
        <ion-select-option value="de">Deutsch</ion-select-option>
      </ion-select>
    </ion-item>
    <ion-item>
      <ion-label position="floating" color="primary">Theme</ion-label>
      <ion-select formControlName="theme" cancelText="Cancel" okText="OK">
        <ion-select-option value="light">Light</ion-select-option>
        <ion-select-option value="dark">Dark</ion-select-option>
      </ion-select>
    </ion-item>-->
  </form>
</ion-content>
