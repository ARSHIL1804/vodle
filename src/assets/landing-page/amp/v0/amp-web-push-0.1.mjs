;
(self.AMP=self.AMP||[]).push({m:1,v:"2203281422000",n:"amp-web-push",ev:"0.1",l:!0,f:function(t,e){(()=>{var{hasOwnProperty:e,toString:i}=Object.prototype;function s(t){const e=Object.create(null);return t&&Object.assign(e,t),e}function r(t){return CSS.escape(t)}var n=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;function o(t,e=""){try{return decodeURIComponent(t)}catch(t){return e}}function u(t){const e=s();if(!t)return e;let i;for(;i=n.exec(t);){const t=o(i[1],i[1]),s=i[2]?o(i[2].replace(/\+/g," "),i[2]):"";e[t]=s}return e}var h=self.AMP_CONFIG||{},l=("string"==typeof h.thirdPartyFrameRegex?new RegExp(h.thirdPartyFrameRegex):h.thirdPartyFrameRegex,("string"==typeof h.cdnProxyRegex?new RegExp(h.cdnProxyRegex):h.cdnProxyRegex)||/^https:\/\/([a-zA-Z0-9_-]+\.)?cdn\.ampproject\.org$/);function c(t){if(!self.document||!self.document.head)return null;if(self.location&&l.test(self.location.origin))return null;const e=self.document.head.querySelector(`meta[name="${t}"]`);return e&&e.getAttribute("content")||null}h.thirdPartyUrl,h.thirdPartyFrameHost,h.cdnUrl||c("runtime-host"),h.errorReportingUrl,h.betaErrorReportingUrl,h.localDev,h.geoApiUrl||c("amp-geo-api"),self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var a=self.__AMP_LOG;function p(t,e){throw new Error("failed to call initLogConstructor")}function d(t){return a.user||(a.user=m()),function(t,e){return e&&e.ownerDocument.defaultView!=t}(a.user.win,t)?a.userForEmbed||(a.userForEmbed=m()):a.user}function m(t){return p()}function f(t,e,i,s,r,n,o,u,h,l,c){return t}var w="amp-web-push",_=w,b=w+"-service",P=w+"-widget",v="granted",g="denied",A="default";function R(t,e){return function(t,e){const i=function(t,e){const i=I(t)[e];return i?i.promise?i.promise:(E(t,e),i.promise=Promise.resolve(i.obj)):null}(t,e);if(i)return i;const s=I(t);return s[e]=function(){const t=new class{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}},{promise:e,reject:i,resolve:s}=t;return e.catch((()=>{})),{obj:null,promise:e,resolve:s,reject:i,context:null,ctor:null}}(),s[e].promise}(function(t){const e=function(t){return t.nodeType?(e=t,i=(e.ownerDocument||e).defaultView,function(t,e){return E(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),e)}(i,"ampdoc")).getAmpDoc(t):t;var e;var i}(t);return e.isSingleDoc()?e.win:e}(t),e)}function E(t,e){f(function(t,e){const i=t.__AMP_SERVICES&&t.__AMP_SERVICES[e];return!(!i||!i.ctor)}(t,e));const i=I(t)[e];return i.obj||(f(i.ctor),f(i.context),i.obj=new i.ctor(i.context),f(i.obj),i.context=null,i.resolve&&i.resolve(i.obj)),i.obj}function I(t){let e=t.__AMP_SERVICES;return e||(e=t.__AMP_SERVICES={}),e}var y,M,S=class extends t.BaseElement{constructor(t){super(t)}isLayoutSupported(t){return"fixed"==t}buildCallback(){this.element.classList.add("amp-invisible")}},T="subscribed",V="unsubscribed",k="blocked";function O(t){return t.data}function C(t,e,i,s){let r=i;const n=function(t,e,i,s){let r=t,n=i,o=t=>{try{return n(t)}catch(t){var e,i;throw null===(e=(i=self).__AMP_REPORT_ERROR)||void 0===e||e.call(i,t),t}};const u=function(){if(void 0!==y)return y;y=!1;try{const t={get capture(){return y=!0,!1}};self.addEventListener("test-options",null,t),self.removeEventListener("test-options",null,t)}catch(t){}return y}(),h=!(null==s||!s.capture);return r.addEventListener(e,o,u?s:h),()=>{null==r||r.removeEventListener(e,o,u?s:h),n=null,r=null,o=null}}(t,e,(t=>{try{r(t)}finally{r=null,n()}}),s);return n}function U(t){return"AUDIO"===t.tagName||"VIDEO"===t.tagName}function $(t,e){return M||(M=self.document.createElement("a")),function(t,e,i){return t.href="",new URL(e,t.href)}(M,t)}new Set(["c","v","a","ad"]);var W=class{constructor(t){t||(t={debug:!1,windowContext:window}),this.vt={},this.Wf={},this.Uf=t.debug,this.Gf=!1,this.Hf=!1,this.js=!1,this.Df=null,this.Kf=null,this.qf=null,this.Jf=null,this.Bf=null,this.Qf=t.windowContext||window}listen(t){return new Promise(((e,i)=>{this.js?i(new Error("Already connected.")):this.Gf?i(new Error("Already listening for connections.")):Array.isArray(t)?(this.qf=this.Zf.bind(this,t,e,i),this.Qf.addEventListener("message",this.qf),this.Uf):i(new Error("allowedOrigins should be a string array of allowed origins to accept messages from. Got:",t))})).then((()=>{this.send(W.Topics.CONNECT_HANDSHAKE,null),this.js=!0}))}Wl(t,e){const i=$(t).origin;for(let t=0;t<e.length;t++)if($(e[t]).origin===i)return!0;return!1}Zf(t,e,i,s){const r=O(s),{origin:n,ports:o}=s;this.Uf,this.Wl(n,t)&&r&&r.topic===W.Topics.CONNECT_HANDSHAKE&&(this.Qf.removeEventListener("message",this.qf),this.Kf=o[0],this.Bf=this.Xf.bind(this),this.Kf.addEventListener("message",this.Bf,!1),this.Kf.start(),e())}connect(t,e){return new Promise(((i,s)=>{t||s(new Error("Provide a valid Window context to connect to.")),e||s(new Error("Provide an expected origin for the remote Window or provide the wildcard *.")),this.js?s(new Error("Already connected.")):this.Hf?s(new Error("Already connecting.")):(this.Df=new MessageChannel,this.Kf=this.Df.port1,this.Jf=this.Yf.bind(this,this.Kf,e,i),this.Kf.addEventListener("message",this.Jf),this.Kf.start(),t.postMessage({topic:W.Topics.CONNECT_HANDSHAKE},"*"===e?"*":$(e).origin,[this.Df.port2]))}))}Yf(t,e,i){this.js=!0,this.Uf,t.removeEventListener("message",this.Jf),this.Bf=this.Xf.bind(this),t.addEventListener("message",this.Bf,!1),i()}static get Topics(){return{CONNECT_HANDSHAKE:"topic-connect-handshake",NOTIFICATION_PERMISSION_STATE:"topic-notification-permission-state",SERVICE_WORKER_STATE:"topic-service-worker-state",SERVICE_WORKER_REGISTRATION:"topic-service-worker-registration",SERVICE_WORKER_QUERY:"topic-service-worker-query",STORAGE_GET:"topic-storage-get"}}Xf(t){const e=O(t);if(this.vt[e.id]&&e.isReply){const t=this.vt[e.id];delete this.vt[e.id];const{promiseResolver:i}=t;t.message=e.data,this.Uf,i([e.data,this.td.bind(this,e.id,t.topic)])}else{const t=this.Wf[e.topic];if(!t)return;this.Uf;for(let i=0;i<t.length;i++)(0,t[i])(e.data,this.td.bind(this,e.id,e.topic))}}on(t,e){this.Wf[t]?this.Wf[t].push(e):this.Wf[t]=[e]}off(t,e){if(e){const i=this.Wf[t].indexOf(e);-1!==i&&this.Wf[t].splice(i,1)}else this.Wf[t]&&delete this.Wf[t]}td(t,e,i){const s={id:t,topic:e,data:i,isReply:!0};return this.Kf.postMessage(s),new Promise((t=>{this.vt[s.id]={message:i,topic:e,promiseResolver:t}}))}send(t,e){const i={id:crypto.getRandomValues(new Uint8Array(10)).join(""),topic:t,data:e};return this.Uf,this.Kf.postMessage(i),new Promise((s=>{this.vt[i.id]={message:e,topic:t,promiseResolver:s}}))}},x="amp-web-push-widget.amp-invisible{visibility:hidden}\n/*# sourceURL=/extensions/amp-web-push/0.1/amp-web-push.css*/";function F(t,e,i){if(e[i])return e[i];const s=t.querySelector(`style[${i}], link[${i}]`);return s?(e[i]=s,s):null}function L(t,e){const i=t.styleSheets;for(let t=0;t<i.length;t++)if(i[t].ownerNode==e)return!0;return!1}function N(t){return R(t,b)}var D=class{static get PERMISSION_POPUP_URL_FRAGMENT(){return"amp-web-push-subscribing=yes"}static get AMP_VERSION_INITIAL(){return 1}constructor(t){this.ampdoc=t,function(t,e,i,r,n){const o=t.getHeadNode(),u=function(t,e,i,r){let n=t.__AMP_CSS_SM;n||(n=t.__AMP_CSS_SM=s());const o=`amp-extension=${r}`;if(o){const i=F(t,n,o);if(i)return"STYLE"==i.tagName&&i.textContent!==e&&(i.textContent=e),i}const u=(t.ownerDocument||t).createElement("style");u.textContent=e;let h=null;return u.setAttribute("amp-extension",r),h=F(t,n,"amp-runtime"),function(t,e,i=null){if(!i)return void function(t,e){t.insertBefore(e,t.firstChild)}(t,e);const s=i.nextSibling;t.insertBefore(e,s)}(t,u,h),o&&(n[o]=u),u}(o,function(t,e){const i=t.__AMP_CSS_TR;return i?i(e):e}(o,"amp-web-push-widget.amp-invisible{visibility:hidden}\n/*# sourceURL=/extensions/amp-web-push/0.1/amp-web-push.css*/"),0,"amp-web-push");if(i){const e=t.getRootNode();if(L(e,u))return u;const i=setInterval((()=>{L(e,u)&&clearInterval(i)}),4)}}(t,0,(()=>{})),this.lU={"helper-iframe-url":null,"permission-dialog-url":null,"service-worker-url":null,debug:null},this.Uf=!1,this.Mv=null,this.twt=null,this.ewt=new W({debug:this.Uf}),this.iwt=null}start(t){if(!this.environmentSupportsWebPush())return Promise.reject("Web push is not supported");this.initializeConfig(t);const e=this.installHelperFrame();return e.then((()=>this.ewt.connect(this.Mv.getDomElement().contentWindow,$(this.lU["helper-iframe-url"]).origin))).then((()=>{if(!this.isContinuingSubscriptionFromRedirect())return this.updateWidgetVisibilities();this.swt()})),e}initializeConfig(t){this.lU=t,this.lU}installHelperFrame(){const t=-1!==this.lU["helper-iframe-url"].indexOf("?")?"&":"?",e=`${this.lU["helper-iframe-url"]}${t}parentOrigin=${this.ampdoc.win.location.origin}`;return this.Mv=new class{constructor(t,e){this.Ci=t,this.ni=e,this.rwt=null,this.wi=new Promise((()=>{}))}load(){return this.Ci.whenReady().then((()=>{var t,e;return this.rwt=this.Ci.win.document.createElement("iframe"),t=this.rwt,void 0===(e=!1)&&(e=t.hasAttribute("hidden")),e?t.removeAttribute("hidden"):t.setAttribute("hidden",""),this.rwt.sandbox="allow-same-origin allow-scripts",this.rwt.src=this.ni,this.Ci.getBody().appendChild(this.rwt),this.wi=function(t){let e,i;if(function(t){return!!(t.complete||"complete"==t.readyState||U(t)&&t.readyState>0||t.document&&"complete"==t.document.readyState)}(t))return Promise.resolve(t);const s=U(t);return s&&t.__AMP_MEDIA_LOAD_FAILURE_SRC===t.currentSrc?Promise.reject(t):new Promise(((r,n)=>{if(e=s?C(t,"loadedmetadata",r,{capture:!0}):C(t,"load",r),!t.tagName)return;let o=t;if(s&&!t.hasAttribute("src")&&(o=function(t,e){for(let i=t.lastElementChild;i;i=i.previousElementSibling)if(e(i))return i;return null}(t,(t=>"SOURCE"===t.tagName)),!o))return n(new Error("Media has no source."));i=C(o,"error",n)})).then((()=>(i&&i(),t)),(()=>{e&&e(),function(t){U(t)&&(t.__AMP_MEDIA_LOAD_FAILURE_SRC=t.currentSrc||!0);let e=t;throw e&&e.src&&(e=e.src),d().createError("Failed to load:",e)}(t)}))}(this.rwt),this.whenReady()}))}getDomElement(){return this.rwt}whenReady(){return this.wi}}(this.ampdoc,e),this.Mv.load()}isContinuingSubscriptionFromRedirect(){return-1!==(this.ampdoc.win.testLocation||this.ampdoc.win.location).search.indexOf(D.PERMISSION_POPUP_URL_FRAGMENT)}removePermissionPopupUrlFragmentFromUrl(t){let e=t.replace(`?${D.PERMISSION_POPUP_URL_FRAGMENT}`,"");return e=e.replace(`&${D.PERMISSION_POPUP_URL_FRAGMENT}`,""),e}nwt(t,e){return this.Mv.whenReady().then((()=>this.ewt.send(t,e))).then((i=>{const s=i[0];if(s.success)return s.result;throw new Error(`AMP page helper iframe query topic ${t} and message ${e} failed with: ${s.error}`)}))}owt(t,e){return this.nwt(W.Topics.SERVICE_WORKER_QUERY,{topic:t,payload:e})}queryNotificationPermission(){return this.nwt(W.Topics.NOTIFICATION_PERMISSION_STATE,null)}uwt(){return this.nwt(W.Topics.SERVICE_WORKER_STATE,null)}registerServiceWorker(){const t=this.lU["service-worker-url"],e=this.lU["service-worker-scope"];return this.nwt(W.Topics.SERVICE_WORKER_REGISTRATION,{workerUrl:t,registrationOptions:e?{scope:e}:{}})}querySubscriptionStateRemotely(){return this.owt("amp-web-push-subscription-state",null)}subscribeForPushRemotely(){return this.owt("amp-web-push-subscribe",null)}unsubscribeFromPushRemotely(){return this.owt("amp-web-push-unsubscribe",null)}isServiceWorkerActivated(){const t=this;return this.uwt().then((e=>{const i=!0===e.isControllingFrame,s=this.isUrlSimilarForQueryParams(e.url,t.lU["service-worker-url"]),r="activated"===e.state;return i&&s&&r}))}isUrlSimilarForQueryParams(t,e){const i=$(t),s=u(i.search),r=$(e),n=u(r.search);for(const t in s)if(n[t]!==s[t])return!1;return i.origin===r.origin&&i.pathname===r.pathname}setWidgetVisibilities(t,e){const i=this.ampdoc.getRootNode().querySelectorAll(`${r(P)}[visibility=${r(t)}]`),s="amp-invisible";for(let t=0;t<i.length;t++){const r=i[t];e?r.classList.remove(s):r.classList.add(s)}}hwt(t){return this.ampdoc.getRootNode().querySelectorAll(`${r(P)}[visibility=${r(t)}]`).length>0}lwt(t){if("boolean"==typeof t)return 1}cwt(){return this.queryNotificationPermission().then((t=>{this.twt=t}))}updateWidgetVisibilities(){return this.cwt().then((()=>this.awt(W.Topics.STORAGE_GET))).then((t=>!0===t?this.pwt("amp-web-push-notification-permission"):Promise.resolve(A))).then((t=>{if(t!==g)return this.isServiceWorkerActivated().then((t=>{t?this.dwt():this.mwt()}));this.hwt(k)?this.fwt():this.mwt()}))}dwt(){return(t=this.ampdoc.win,E(t,"timer")).timeoutPromise(5e3,this.querySubscriptionStateRemotely().then((t=>{if(this.lwt(t)!==D.AMP_VERSION_INITIAL)throw d().createError("The controlling service worker replied to amp-web-push with an unexpected value.");t?(this.setWidgetVisibilities(V,!1),this.setWidgetVisibilities(T,!0),this.setWidgetVisibilities(k,!1)):this.mwt()})),"The controlling service worker does not support amp-web-push.");var t}mwt(){this.setWidgetVisibilities(V,!0),this.setWidgetVisibilities(T,!1),this.setWidgetVisibilities(k,!1)}fwt(){this.setWidgetVisibilities(V,!1),this.setWidgetVisibilities(T,!1),this.setWidgetVisibilities(k,!0)}subscribe(t){const e=[];return e.push(this.registerServiceWorker()),e.push(new Promise((e=>{if(this.twt===v)return this.wwt().then((()=>{e()}));{const i=this.openPopupOrRedirect();this._wt(i,t),this.iwt=new W({debug:this.Uf}),this.iwt.listen([this.lU["permission-dialog-url"]]),this.onPermissionDialogInteracted().then((t=>this.handlePermissionDialogInteraction(t))).then((()=>{e()}))}}))),Promise.all(e)}_wt(t,e){if(t&&!t.closed){const i=this.ampdoc.win.setInterval((()=>{t.closed&&(e(),this.ampdoc.win.clearInterval(i))}),500)}}handlePermissionDialogInteraction(t){const e=t[0],i=t[1];switch(e){case g:case A:return i({closeFrame:!0}),this.updateWidgetVisibilities();case v:i({closeFrame:!0}),this.wwt();break;default:throw new Error("Unexpected permission value:",e)}}wwt(){return this.subscribeForPushRemotely().then((()=>this.updateWidgetVisibilities()))}unsubscribe(){return this.unsubscribeFromPushRemotely().then((()=>this.updateWidgetVisibilities()))}awt(t){return this.nwt(W.Topics.NOTIFICATION_PERMISSION_STATE,{isQueryTopicSupported:t})}pwt(t){return this.nwt(W.Topics.STORAGE_GET,{key:t})}onPermissionDialogInteracted(){return new Promise((t=>{this.iwt.on(W.Topics.NOTIFICATION_PERMISSION_STATE,((e,i)=>{t([e,i])}))}))}static bwt(){const t=Math.floor(Math.min(700,.9*screen.width)),e=Math.floor(Math.min(450,.9*screen.height));return{w:t,h:e,x:Math.floor((screen.width-t)/2),y:Math.floor((screen.height-e)/2)}}openPopupOrRedirect(){const t=-1!==this.ampdoc.win.location.href.indexOf("?")?"&":"?",e=this.ampdoc.win.location.href+t+D.PERMISSION_POPUP_URL_FRAGMENT,i=-1!==this.lU["permission-dialog-url"].indexOf("?")?"&":"?",s=this.lU["permission-dialog-url"]+i+`return=${encodeURIComponent(e)}`,r=D.bwt(),n=`height=${r.h},width=${r.w},left=${r.x},top=${r.y},resizable=yes,scrollbars=yes`;return function(t,e,i,s){let r;try{r=t.open(e,i,s)}catch(t){(a.dev||(a.dev=p())).error("DOM","Failed to open url on target: ",i,t)}var n,o;return!r&&("number"!=typeof o&&(o=0),o+"noopener".length>(n=s||"").length||-1===n.indexOf("noopener",o))&&(r=t.open(e,"_top")),r}(this.ampdoc.win,s,"_blank",n)}swt(){this.ampdoc.win.history.replaceState(null,"",this.removePermissionPopupUrlFragmentFromUrl(this.ampdoc.win.location.href)),this.queryNotificationPermission().then((t=>{switch(t){case g:case A:return this.updateWidgetVisibilities();case v:this.wwt();break;default:throw new Error("Unexpected permission value",t)}}))}environmentSupportsWebPush(){return this.Pwt()&&this.vwt()}Pwt(){return void 0!==this.ampdoc.win.Notification&&void 0!==this.ampdoc.win.navigator.serviceWorker&&void 0!==this.ampdoc.win.PushManager}vwt(){return"https:"===this.ampdoc.win.location.protocol||"localhost"===this.ampdoc.win.location.hostname||"127.0.0.1"===this.ampdoc.win.location.hostname||!1}},q={HELPER_FRAME_URL:"helper-iframe-url",PERMISSION_DIALOG_URL:"permission-dialog-url",SERVICE_WORKER_URL:"service-worker-url",SERVICE_WORKER_SCOPE:"service-worker-scope"},j=class extends t.BaseElement{constructor(t){super(t)}validate(){this.gwt(),this.Awt();const t={"helper-iframe-url":null,"permission-dialog-url":null,"service-worker-url":null,"service-worker-scope":null};for(const p in q){const m=q[p];e=this.element.getAttribute(m)||"service-worker-scope"===m,i=`The ${m} attribute is required for <amp-web-push>`,s=void 0,r=void 0,n=void 0,o=void 0,u=void 0,h=void 0,l=void 0,c=void 0,a=void 0,d().assert(e,i,s,r,n,o,u,h,l,c,a),t[m]=this.element.getAttribute(m)}var e,i,s,r,n,o,u,h,l,c,a;if(!this.Rwt(t["helper-iframe-url"]))throw d().createError("<amp-web-push> must have a valid helper-iframe-url attribute. It should begin with the https:// protocol and point to the provided lightweight template page provided for AMP messaging.");if(!this.Rwt(t["permission-dialog-url"]))throw d().createError("<amp-web-push> must have a valid permission-dialog-url attribute. It should begin with the https:// protocol and point to the provided template page for showing the permission prompt.");if("https:"!==$(t["service-worker-url"]).protocol)throw d().createError("<amp-web-push> must have a valid service-worker-url attribute. It should begin with the https:// protocol and point to the service worker JavaScript file to be installed.");if($(t["service-worker-url"]).origin!==$(t["permission-dialog-url"]).origin||$(t["permission-dialog-url"]).origin!==$(t["helper-iframe-url"]).origin)throw d().createError("<amp-web-push> URL attributes service-worker-url, permission-dialog-url, and helper-iframe-url must all share the same origin.")}parseConfig(){const t={};for(const e in q){const i=q[e];t[i]=this.element.getAttribute(i)}return t}buildCallback(){this.validate();const t=this.parseConfig();N(this.element).then((e=>{e.start(t).catch((()=>{}))})),this.registerAction("subscribe",this.Ewt.bind(this)),this.registerAction("unsubscribe",this.Iwt.bind(this))}gwt(){if(this.element.getAttribute("id")!==w)throw d().createError("<amp-web-push> must have an id attribute with value '"+w+"'.")}Awt(){if(this.getAmpDoc().getRootNode().querySelectorAll(`#${r(_)}`).length>1)throw d().createError("Only one <amp-web-push> element may exist on a page.")}Ewt(t){const e=t.event.target;this.ywt(e,!0),N(this.element).then((t=>{t.subscribe((()=>{this.ywt(e,!1)})).then((()=>{this.ywt(e,!1)}))}))}ywt(t,e){t.disabled=e}Iwt(t){const e=t.event.target;this.ywt(e,!0),N(this.element).then((t=>{t.unsubscribe().then((()=>{this.ywt(e,!1)}))}))}Rwt(t){try{const e=$(t),i=e.pathname.length>1;return"https:"===e.protocol&&i}catch(t){return!1}}};t.registerServiceForDoc(b,D),t.registerElement(_,j),t.registerElement(P,S,x)})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-web-push-0.1.mjs.map